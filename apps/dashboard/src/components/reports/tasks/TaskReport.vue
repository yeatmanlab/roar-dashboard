<template>
  <div :id="'tab-view-description-' + taskId" class="flex flex-col items-center justify-center mx-2">
    <div>
      <div style="text-transform: uppercase" class="text-2xl font-bold mt-3">{{ taskInfoById[taskId]?.subheader }}</div>
      <!-- The following HTML is from a hard-coded source (below) -->
      <!-- eslint-disable-next-line vue/no-v-html -->
      <p class="mt-1 text-md font-light mb-3" v-html="taskDesc"></p>
    </div>
  </div>
  <div v-if="tasksToDisplayGraphs.includes(taskId)" :id="'tab-view-chart-' + taskId" class="chart-toggle-wrapper">
    <div v-if="orgType === 'district'" class="mb-3" data-html2canvas-ignore="true">
      <div class="flex uppercase text-xs font-light justify-content-center align-items-center">view rows by</div>
      <PvSelectButton
        v-model="facetMode"
        class="flex flex-row my-2 select-button"
        :allow-empty="false"
        :options="facetModes"
        option-label="name"
      />
    </div>
    <div class="chart-wrapper align-items-start">
      <div class="h-full flex flex-column align-items-center">
        <DistributionChartSupport
          :initialized="initialized"
          :administration-id="administrationId"
          :org-type="orgType"
          :org-id="orgId"
          :task-id="taskId"
          :runs="runs"
          :facet-mode="facetMode"
        />
      </div>
      <div class="h-full flex">
        <DistributionChartFacet
          :initialized="initialized"
          :administration-id="administrationId"
          :org-type="orgType"
          :org-id="orgId"
          :task-id="taskId"
          :runs="runs"
          :facet-mode="facetMode"
          :min-grade-by-runs="minGradeByRuns"
        />
      </div>
    </div>
  </div>
  <div v-if="orgType !== 'district'" class="my-2 mx-4">
    <SubscoreTable
      v-if="taskId === 'phonics' && !isLoadingTasksDictionary"
      task-id="phonics"
      :task-name="tasksDictionary['phonics'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
    <SubscoreTable
      v-if="taskId === 'letter' && !isLoadingTasksDictionary"
      task-id="letter"
      :task-name="tasksDictionary['letter'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
    <SubscoreTable
      v-if="taskId === 'letter-en-ca' && !isLoadingTasksDictionary"
      task-id="letter-en-ca"
      :task-name="tasksDictionary['letter-en-ca'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
    <SubscoreTable
      v-if="taskId === 'pa' && !isLoadingTasksDictionary"
      task-id="pa"
      :task-name="tasksDictionary['pa'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
    <SubscoreTable
      v-if="taskId === 'fluency-calf' && !isLoadingTasksDictionary"
      task-id="fluency-calf"
      :task-name="tasksDictionary['fluency-calf'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
    <SubscoreTable
      v-if="taskId === 'fluency-arf' && !isLoadingTasksDictionary"
      task-id="fluency-arf"
      :task-name="tasksDictionary['fluency-arf'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
    <SubscoreTable
      v-if="taskId === 'roam-alpaca' && !isLoadingTasksDictionary"
      task-id="roam-alpaca"
      :task-name="tasksDictionary['roam-alpaca'].publicName"
      :administration-id="administrationId"
      :org-type="orgType"
      :org-id="orgId"
      :administration-name="administrationInfo.name ?? undefined"
      :org-name="orgInfo.name ?? undefined"
      :computed-table-data="computedTableData"
    />
  </div>
</template>
<script setup>
import { ref, computed } from 'vue';
import PvSelectButton from 'primevue/selectbutton';
import { tasksToDisplayGraphs, taskInfoById, replaceScoreRange } from '@/helpers/reports.js';
import useTasksDictionaryQuery from '@/composables/queries/useTasksDictionaryQuery.js';
import SubscoreTable from '@/components/reports/SubscoreTable.vue';
import DistributionChartFacet from '@/components/reports/DistributionChartFacet.vue';
import DistributionChartSupport from '@/components/reports/DistributionChartSupport.vue';

const props = defineProps({
  initialized: {
    type: Boolean,
    required: true,
  },
  administrationId: {
    type: String,
    required: true,
  },
  administrationInfo: {
    type: Object,
    required: true,
  },
  computedTableData: {
    type: Array,
    required: true,
  },
  orgType: {
    type: String,
    required: true,
  },
  orgId: {
    type: String,
    required: true,
  },
  orgInfo: {
    type: Object,
    required: true,
  },
  taskId: {
    type: String,
    required: true,
  },
  runs: {
    type: Array,
    required: true,
  },
  taskScoringVersions: {
    type: Object,
    required: true,
  },
});

const { data: tasksDictionary, isLoading: isLoadingTasksDictionary } = useTasksDictionaryQuery();

const facetMode = ref({ name: 'Grade', key: 'grade' });
const facetModes = [
  { name: 'Grade', key: 'grade' },
  { name: 'School', key: 'schoolName' },
];

const minGradeByRuns = computed(() => {
  if (props.orgType === 'district') {
    // For district, props.runs is an object with support categories
    // We need to extract all grade values from the nested structure
    if (!props.runs || typeof props.runs !== 'object') {
      return 0;
    }
    const allGrades = [];
    Object.values(props.runs).forEach((category) => {
      if (category && typeof category === 'object' && category.grades) {
        allGrades.push(...Object.keys(category.grades));
      }
    });
    return allGrades.length > 0 ? Math.min(...allGrades.map(Number)) : 0;
  }
  return Math.min(
    ...props.runs.filter((run) => run.scores.rawScore || run.scores.stdPercentile).map((run) => run.grade),
  );
});

const taskDesc = computed(() => {
  return replaceScoreRange(taskInfoById[props.taskId]?.desc, props.taskId, props.taskScoringVersions[props.taskId]);
});
</script>

<style>
.chart-wrapper {
  display: flex;
  height: 100%;
  flex-wrap: wrap;
  justify-content: space-around;
}

.chart-toggle-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.task-card {
  background: #f6f6fe;
  padding: 2rem;
  text-align: center;
  margin-bottom: 1rem;
}

.task-title {
  font-size: 3.5rem;
  /* font-weight: bold; */
}

.task-description {
  font-size: 1.25rem;
  text-align: left;
}
</style>
