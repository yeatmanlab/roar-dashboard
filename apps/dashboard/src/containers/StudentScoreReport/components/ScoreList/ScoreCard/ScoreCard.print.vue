<template>
  <div class="p-4 mb-4 text-sm rounded border border-gray-200 border-solid break-inside-avoid">
    <div class="flex justify-between align-items-center">
      <h2 class="m-0 text-lg font-semibold">{{ publicName }}</h2>

      <table class="mt-1 text-sm border-collapse sm:mt-0">
        <tbody>
          <tr v-for="tag in tags" :key="tag.value" class="font-medium">
            <td class="pr-2 text-right">{{ tag.label }}:</td>
            <td :class="`text-${getSeverityColor(tag.severity)}-700`">{{ tag.value }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="py-3 mt-3 border-t border-gray-200">
      <div>
        <span class="font-semibold">{{ score.name }}: </span>
        <span class="font-semibold" :style="{ color: score.supportColor }">
          {{ getFromScoreValueTemplate(score.value) }}
        </span>
      </div>

      <i18n-t :keypath="description.keypath" tag="p" class="mb-0">
        <template #firstName>{{ studentFirstName }}</template>
        <template v-for="(_, slotName) in description.slots" #[slotName] :key="slotName">
          <template v-if="slotName === 'taskDescription'">
            {{ description.slots[slotName] }}
          </template>
          <strong v-else>{{ description.slots[slotName] }}</strong>
        </template>
      </i18n-t>

      <h3 class="mt-4 text-xs font-semibold uppercase">{{ $t('scoreReports.scoreBreakdown') }}</h3>
      <table class="w-full border-collapse">
        <thead>
          <tr>
            <th class="px-2 py-1 font-semibold text-left border border-gray-300 border-solid">Metric</th>
            <th class="px-2 py-1 font-semibold text-left border border-gray-300 border-solid">Score</th>
            <th class="px-2 py-1 font-semibold text-left border border-gray-300 border-solid">Range</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="[key, rawScore, rangeMin, rangeMax] in scoresArray" :key="key">
            <template v-if="!isNaN(rawScore)">
              <td class="px-2 py-1 border border-gray-300 border-solid">{{ key }}</td>

              <td class="px-2 py-1 font-bold border border-gray-300 border-solid">
                {{ isNaN(rawScore) ? rawScore : Math.round(rawScore) }}
              </td>

              <td class="px-2 py-1 border border-gray-300 border-solid">{{ rangeMin }}-{{ rangeMax }}</td>
            </template>
          </tr>
        </tbody>
      </table>

      <template v-if="FEATURE_FLAGS.ENABLE_LONGITUDINAL_REPORTS">
        <h3 class="mt-4 text-xs font-semibold uppercase">{{ $t('scoreReports.progressOverTime') }}</h3>
        <LongitudinalChart
          :longitudinal-data="longitudinalData"
          :task-id="taskId"
          :student-grade="studentGrade"
          :current-assignment-id="currentAssignmentId"
        />
      </template>
    </div>
  </div>
</template>

<script setup>
import { LongitudinalChartPrint as LongitudinalChart } from './LongitudinalChart';
import { FEATURE_FLAGS } from '@/constants/featureFlags';

const props = defineProps({
  publicName: {
    type: String,
    required: true,
  },
  scoreLabel: {
    type: String,
    required: true,
  },
  score: {
    type: Object,
    required: true,
    validator: (value) => {
      return (
        typeof value === 'object' &&
        value !== null &&
        ('value' in value || 'supportColor' in value || 'min' in value || 'max' in value || 'subscores' in value)
      );
    },
  },
  tags: {
    type: Array,
    required: true,
  },
  valueTemplate: {
    type: String,
    required: false,
    default: undefined,
  },
  scoreToDisplay: {
    type: String,
    required: true,
  },
  studentFirstName: {
    type: String,
    required: true,
  },
  studentGrade: {
    type: String,
    required: true,
  },
  description: {
    type: Object,
    required: true,
  },
  scoresArray: {
    type: Array,
    required: true,
  },
  longitudinalData: {
    type: Array,
    required: false,
    default: () => [],
  },
  taskId: {
    type: String,
    required: true,
  },
  currentAssignmentId: {
    type: String,
    required: true,
  },
});

/**
 * The severity to color mapping for tags
 */
const severityToColor = {
  success: 'green',
  warning: 'yellow',
  error: 'red',
  info: 'blue',
};

/**
 * Returns the CSS/TailwindCSS color based on the severity.
 *
 * @param {string} severity – The severity to be converted to a color
 * @returns {string} The severity color
 */
const getSeverityColor = (severity) => severityToColor[severity];

/**
 * Returns the formatted score value based on the value template.
 *
 * In the web view, this is handled automatically by the PrimeVue knob component but requires manual handling in the
 * print view.
 *
 * @param {number} scoreValue – The score value to be formatted
 * @returns {string} The formatted score value
 */
const getFromScoreValueTemplate = (scoreValue) => {
  if (props.valueTemplate) {
    return props.valueTemplate.replace('{value}', scoreValue);
  }

  return scoreValue;
};
</script>
