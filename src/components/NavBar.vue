<template>
  <header id="site-header" class="navbar-container">
    <nav class="container flex flex-row align-items-center">
    <nav class="container flex flex-row align-items-center">
      <router-link :to="{ name: 'Home' }">
        <div class="navbar-logo">
          <PvImage v-if="isLevante" src="/LEVANTE/Levante_Logo.png" alt="LEVANTE Logo" width="200" />
          <ROARLogo v-else />
        </div>
      </router-link>

      <div id="navBarRightEnd" class="flex flex-row align-items-center">
        <PvDropdown
          v-model="$i18n.locale"
          class="mr-2"
          :options="languageDropdownOptions"
          option-label="name"
          option-value="value"
          placeholder="Select language"
          :highlight-on-select="true"
        >
          <template #value="locale">
            <div v-if="locale.value" class="flex flex-row justify-content-center align-items-center">
              <country-flag :country="getCountryFlag(locale.value)" class="mr-2" size="small" />
              <span>{{ getCountryName(locale.value) }}</span>
            </div>
            <span v-else>
              {{ locale.placeholder }}
            </span>
          </template>
          <template #option="country">
            <div class="flex flex-row justify-content-start align-items-center">
              <country-flag :country="country.option.code" class="mr-2" size="small" />
              <span>{{ country.option.name }}</span>
            </div>
          </template>
        </PvDropdown>

        <div class="login-container">
          <div v-if="isAdmin">
            <PvButton label="Menu" icon="pi pi-bars" @click="toggleMenu" />
            <PvMenu ref="menu" :model="dropDownActions" :popup="true">
              <template #item="{ item }">
                <div class="cursor-pointer hover:surface-200">
                  <i :class="item.icon" class="p-1 pb-2 pt-2 text-sm cursor-pointer"></i> {{ item.label }}
                </div>
              </template>
            </PvMenu>
          </div>
          <router-link :to="{ name: 'SignOut' }" class="signout-button">
            <PvButton data-cy="button-sign-out" class="no-underline">{{ $t('navBar.signOut') }}</PvButton>
          </router-link>
        </div>
      </div>
    </nav>
  </header>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { storeToRefs } from 'pinia';
import { useAuthStore } from '@/store/auth';
import _get from 'lodash/get';
import _isEmpty from 'lodash/isEmpty';
import _union from 'lodash/union';
import { getSidebarActions } from '@/router/sidebarActions';
import { fetchDocById } from '@/helpers/query/utils';
import { useQuery } from '@tanstack/vue-query';
import { languageOptions } from '../translations/i18n.js';
import CountryFlag from 'vue-country-flag-next';

const router = useRouter();
const authStore = useAuthStore();
const { roarfirekit } = storeToRefs(authStore);
const initialized = ref(false);
const menu = ref();
const isLevante = import.meta.env.MODE === 'LEVANTE';
let unsubscribe;

const init = () => {
  if (unsubscribe) unsubscribe();
  initialized.value = true;
};

unsubscribe = authStore.$subscribe(async (mutation, state) => {
  if (state.roarfirekit.restConfig) init();
});

onMounted(() => {
  if (roarfirekit.value.restConfig) init();
});

const { data: userClaims } = useQuery({
  queryKey: ['userClaims', authStore.uid],
  queryFn: () => fetchDocById('userClaims', authStore.uid),
  keepPreviousData: true,
  enabled: initialized,
  staleTime: 5 * 60 * 1000, // 5 minutes
});

const isAdmin = computed(() => {
  if (userClaims.value?.claims?.super_admin) return true;
  if (_isEmpty(_union(...Object.values(userClaims.value?.claims?.minimalAdminOrgs ?? {})))) return false;
  return true;
});

const isSuperAdmin = computed(() => Boolean(userClaims.value?.claims?.super_admin));

const isAtHome = computed(() => {
  return router.currentRoute.value.fullPath === '/';
});

// Convert the object to an array of [key, value] pairs
let languageOptionsArray = Object.entries(languageOptions);

// Sort the array by the key (language code)
languageOptionsArray.sort((a, b) => a[0].localeCompare(b[1]));

// Convert it back to an object
let sortedLanguageOptions = Object.fromEntries(languageOptionsArray);

const languageDropdownOptions = computed(() => {
  return Object.entries(sortedLanguageOptions).map(([key, value]) => {
    return {
      name: value.country,
      code: value.code,
      value: key,
    };
  });
});

const getCountryName = (locale) => {
  return languageOptions[locale].country;
};

const getCountryFlag = (locale) => {
  return languageOptions[locale].code;
};

const dropDownActions = computed(() => {
  const rawActions = getSidebarActions({
    isSuperAdmin: isSuperAdmin.value,
    isAdmin: isAdmin.value,
    includeHomeLink: !isAtHome.value,
  });
  return rawActions.map((action) => {
    return {
      label: action.title,
      icon: action.icon,
      command: () => {
        router.push(action.buttonLink);
      },
    };
  });
});

let dropdownItems = ref([
  {
    label: authStore.isAuthenticated ? 'Home' : 'Log in',
    icon: authStore.isAuthenticated ? 'pi pi-user' : 'pi pi-sign-in',
    command: () => {
      authStore.isAuthenticated ? router.push({ name: 'Home' }) : router.push({ name: 'SignIn' });
    },
  },
  {
    label: 'Sign Out',
    icon: 'pi pi-sign-out',
    command: () => {
      router.push({ name: 'SignOut' });
    },
  },
]);

if (authStore.isAuthenticated && _get(roarfirekit.value, 'userData.userType') === 'admin') {
  dropdownItems.value.splice(
    1,
    0,
    {
      label: 'Student Upload',
      icon: 'pi pi-users',
      command: () => {
        router.push({ name: 'RegisterStudents' });
      },
    },
    {
      label: 'Query',
      icon: 'pi pi-cloud-download',
      command: () => {
        router.push({ name: 'Query' });
      },
    },
    {
      label: 'Score Report',
      icon: 'pi pi-upload',
      command: () => {
        router.push({ name: 'UploadScores' });
      },
    },
  );
}

const toggleMenu = (event) => {
  menu.value.toggle(event);
};

import ROARLogo from '@/assets/RoarLogo.vue';
import LanguageSelector from './LanguageSelector.vue';
</script>

<style scoped></style>
